# План: кастомний образ Anthias для Raspberry Pi 4

## Поточний стан

- Репо: `/home/serv/Anthias/Antias Play` (master, коміт f6e96cd7)
- Тестова Pi 4: `192.168.91.85:80` (balena OS, старий образ, SSH закритий)
- Віддалений x86 плеєр: `192.168.88.226:8080` (Docker, вже працює)
- Збірка: на локальній машині (192.168.91.92, x86) через `docker buildx` + QEMU для arm64

---

## Фіча 1: Мультимовність (i18n)

### Що є зараз
- Весь UI англійською, захардкоджений
- Frontend: React 19 + TypeScript + Webpack
- Компоненти: `static/src/components/` (~10 TSX файлів)

### Що потрібно зробити
1. Встановити `react-i18next` + `i18next` в `package.json`
2. Створити файли перекладів `static/src/locales/`:
   - `en.json` — англійська (базова)
   - `uk.json` — українська
   - `ru.json` — російська
   - (потім можна додати інші)
3. Створити `static/src/i18n.ts` — ініціалізація i18next
4. Обернути всі рядки в компонентах у `t('key')`:
   - `static/src/components/settings/` — 8 компонентів
   - `static/src/components/app.tsx` — головний
   - `static/src/components/add-asset-modal/`
   - `static/src/components/edit-asset-modal/`
   - `static/src/components/system-info.tsx`
   - Navbar/header
5. Додати вибір мови в Settings UI (dropdown)
6. Зберігати мову в `localStorage` або в `screenly.conf`

### Обсяг
~100-150 рядків для перекладу. Середня складність, 1-2 сесії.

---

## Фіча 2: Screenshot API

### Що є зараз
- Ніякого скриншот-функціоналу
- Viewer рендерить у framebuffer `/dev/fb0`
- На Pi 4 також `/dev/fb0` (доступний у privileged контейнері)

### Що потрібно зробити
1. Новий API endpoint: `GET /api/v2/screenshot`
2. Backend (в `api/views/v2.py`):
   ```python
   # Читає /dev/fb0, конвертує в JPEG через Pillow
   # Повертає image/jpeg
   # Параметри: ?width=640&quality=70 (для превью)
   ```
3. Додати `Pillow` в requirements (вже є?)
4. Зареєструвати URL в `api/urls/v2.py`
5. Інтеграція з Fleet Manager:
   - Fleet Manager вже має поле в `AnthiasAPIClient` — додати метод `get_screenshot()`
   - Показувати превью в dashboard/player detail

### Навантаження на Pi 4
- Читання fb0: ~10-50ms (просто memcpy)
- Конвертація в JPEG 640px: ~50-100ms
- Разом: ~100-150ms на запит — мінімальне навантаження
- Рекомендація: кешувати на 5-10 секунд, не давати DDoS-ити

### Нюанс для x86
- На x86 fb0 теж доступний — працюватиме однаково
- Потрібно визначити розмір/формат framebuffer динамічно

---

## Фіча 3: Resolution через API

### Що є зараз
- `resolution` є в `screenly.conf` секція `[main]`
- НЕ виставлений через API (`DeviceSettingsSerializerV2` не включає)
- На Pi 4 тестовій "не на весь екран" — треба подивитися поточне значення

### Що потрібно зробити
1. Додати `resolution` в `DeviceSettingsSerializerV2`
2. Додати в frontend Settings — dropdown з варіантами:
   - 1920x1080, 2560x1440, 1280x720, auto
3. При зміні — перезапуск viewer (через ZMQ)
4. Fleet Manager: додати відображення resolution в info плеєра

---

## Фіча 4: SSH за замовчуванням

### Варіанти

**А) Docker Compose деплой (рекомендований для нас)**
- SSH вже є в Raspberry Pi OS — потрібно лише увімкнути:
  - `sudo systemctl enable ssh && sudo systemctl start ssh`
  - Або покласти файл `ssh` в `/boot/firmware/` при прошивці
- В наших кастомних Docker-образах SSH не потрібен (це рівень ОС)
- Створити скрипт `setup-pi.sh` який:
  1. Встановлює Docker
  2. Включає SSH
  3. Створює `docker-compose.yml`
  4. Запускає сервіси

**Б) Кнопка в Settings UI Anthias**
- Новий endpoint: `POST /api/v2/ssh` з body `{"enabled": true/false}`
- Через `host_agent` виконати `systemctl enable/start ssh` або `systemctl stop/disable ssh`
- Потребує `host_agent` запущений на хості
- Складніше, але красивіше
- В Settings UI: toggle "SSH Access" з попередженням про безпеку

### Рекомендація
Варіант А для MVP (SSH увімкнений за замовчуванням в образі/скрипті).
Варіант Б додати пізніше як фічу.

---

## Фіча 5: Стокові налаштування

### Зміни в `screenly.conf` (дефолти):
```ini
[main]
show_splash = off          # було on — прибрати 60-секундний сплеш
default_duration = 10      # залишити
shuffle_playlist = off     # було on — послідовний порядок за замовчуванням
default_assets = off       # було on — не вантажити демо-контент

[viewer]
audio_output = hdmi
debug_logging = off        # було on — зменшити логи в проді
```

### Зміни в коді:
- `viewer/constants.py`: `SPLASH_DELAY = 5` (було 60)
- `ENVIRONMENT=development` вшити в docker-compose для Docker-деплою

---

## Порядок реалізації

### Етап 1 — Backend фічі (в репо, тестуємо на x86)
1. [ ] Screenshot API endpoint
2. [ ] Resolution в device_settings API
3. [ ] Стокові налаштування (screenly.conf defaults + SPLASH_DELAY)

### Етап 2 — Frontend i18n
4. [ ] Встановити react-i18next
5. [ ] Створити i18n.ts + локалі (en, uk, ru)
6. [ ] Обернути всі компоненти в t()
7. [ ] Додати вибір мови в Settings
8. [ ] Додати resolution в Settings UI

### Етап 3 — Збірка та деплой Pi 4
9. [ ] Налаштувати docker buildx для arm64
10. [ ] Зібрати кастомні образи для Pi 4
11. [ ] Створити setup-pi.sh скрипт
12. [ ] Тестування на Pi 4 (192.168.91.85)

### Етап 4 — Інтеграція з Fleet Manager
13. [ ] Додати screenshot у AnthiasAPIClient
14. [ ] Показувати превью в dashboard
15. [ ] Показувати resolution в player info

---

## Технічні деталі збірки

### Cross-compile на локальній машині:
```bash
# 1. Увімкнути QEMU emulation
docker run --privileged --rm tonistiigi/binfmt --install arm64

# 2. Створити builder
docker buildx create --name anthias-builder --use

# 3. Збірка кожного сервісу
docker buildx build --platform linux/arm64 \
  -f docker/Dockerfile.server \
  -t anthias-custom/server:latest-pi4 \
  --load .

# Repeat for viewer, nginx, celery, websocket, redis
```

### Або на самій Pi 4 (швидше):
```bash
# Pi 4 OS setup
ssh pi@192.168.91.85
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker pi
git clone https://github.com/Screenly/Anthias.git ~/screenly
cd ~/screenly
docker compose build
docker compose up -d
```

---

## Файли що будуть змінені

### Backend (Python/Django):
- `api/views/v2.py` — screenshot endpoint
- `api/urls/v2.py` — URL routing
- `api/serializers/v2.py` — resolution в settings
- `settings.py` — resolution property
- `viewer/constants.py` — SPLASH_DELAY
- `requirements/` — Pillow (якщо ще немає)

### Frontend (React/TypeScript):
- `package.json` — react-i18next dependency
- `static/src/i18n.ts` — NEW: i18next config
- `static/src/locales/en.json` — NEW: English translations
- `static/src/locales/uk.json` — NEW: Ukrainian translations
- `static/src/locales/ru.json` — NEW: Russian translations
- `static/src/components/settings/` — i18n + language picker + resolution
- `static/src/components/app.tsx` — i18n provider
- `static/src/components/add-asset-modal/` — i18n
- `static/src/components/edit-asset-modal/` — i18n
- `static/src/components/system-info.tsx` — i18n
- `webpack.common.js` — можливо: copy locales

### Docker:
- `docker-compose.yml.tmpl` — ENVIRONMENT=development, defaults
- Можливо: custom Dockerfile для viewer/server
